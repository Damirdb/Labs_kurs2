#include <WiFi.h>
#include <WebSocketsServer.h>
#include <Wire.h>
#include <Adafruit_SHT31.h>
#include <Adafruit_LPS2X.h>

WebSocketsServer webSocket = WebSocketsServer(81);

Adafruit_SHT31 sht31 = Adafruit_SHT31();
Adafruit_LPS2X lps25 = Adafruit_LPS2X();

char ssid[50];     // Массив для хранения SSID
char password[50]; // Массив для хранения пароля

void setup() {
  Serial.begin(115200);
  delay(2000);

  Serial.println("Введите SSID:");
  while (!Serial.available()) {
    // Ожидаем ввода SSID
  }
  Serial.readBytesUntil('\n', ssid, sizeof(ssid));

  Serial.println("Введите пароль:");
  while (!Serial.available()) {
    // Ожидаем ввода пароля
  }
  Serial.readBytesUntil('\n', password, sizeof(password));

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Подключение к WiFi...");
  }

  Serial.println("Подключено к WiFi");

  if (!sht31.begin(0x44)) {
    Serial.println("Датчик SHT31 не обнаружен");
    while (1) delay(1);
  }

  if (!lps25.begin_I2C()) {
    Serial.println("Датчик LPS25 не обнаружен");
    while (1) delay(1);
  }

  webSocket.begin();
  webSocket.onEvent(webSocketEvent);
}

void loop() {
  webSocket.loop();
  float temperature = sht31.readTemperature();
  float humidity = sht31.readHumidity();
  float pressure = lps25.readPressure();
  String data = "{\"temperature\":" + String(temperature) + ",\"humidity\":" + String(humidity) + ",\"pressure\":" + String(pressure) + "}";
  webSocket.broadcastTXT(data);
  delay(1000);
}

void webSocketEvent(uint8_t num, WStype_t type, uint8_t *payload, size_t length) {
  // Обработка событий WebSocket, если необходимо
}
